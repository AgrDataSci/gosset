---
title: '`gosset`: An R package for analysis and synthesis of ranking data in agricultural
  experimentation'
abstract: null
output:
  pdf_document:
    fig_caption: yes
    number_sections: no
    keep_tex: no
#output: word_document: default
latex_engine: pdflatex
editor_options:
  markdown:
    wrap: 72
bibliography: paper.bib
csl: citationstyle.csl
header-includes:
- \usepackage{pdfpages}
- \usepackage{caption}
- \usepackage{xcolor}
- \captionsetup[figure]{font=small}
- \captionsetup[table]{font=small}
---

```{r setup_opts, include=FALSE}
library("knitr")
knitr::opts_chunk$set(echo = FALSE,
                      error = FALSE,
                      message=FALSE,
                      warning = FALSE)
```



>Kauê de Sousa^1,2[*]^, David Brown^3,4^, Jonathan Steinke^2,5^, Jacob van Etten^2^  
>-
>
^1^ Department of Agricultural Sciences, Inland Norway University of Applied Sciences, 2318 Hamar, Norway  
^2^ Digital Inclusion, Bioversity International, Parc Scientifique Agropolis II, 34397, Montpellier Cedex 5, France   
^3^ Laboratory of Geo-Information Science and Remote Sensing, Wageningen University & Research, Droevendaalsesteeg 3, 6708 PB, Wageningen, The Netherlands   
^4^ Digital Inclusion, Bioversity International, 30501, Turrialba, Costa Rica   
^5^ Humboldt University Berlin, Berlin, Germany  

^[*]^ Correspondence should be addressed to: <kaue.desousa@inn.no>

# Abstract
Appropriate data management and analysis are necessary to produce practical information from agricultural experimentation data. There is also an ongoing trend advocating for programmatic tools that supports reproducible workflows in scientific research. We developed the R package gosset, providing functionality to support analysis workflows with rank-based models, such as Plackett-Luce and Bradley-Terry. The gosset package facilitates data preparation, modelling and results presentation stages. We demonstrate the functionality of the package with a case of on-farm evaluations of common bean (*Phaseolus vulgaris* L.) genotypes in Nicaragua.

::: frontmatter
::: keyword
**Keywords**: Bradley-Terry, Plackett-Luce, data science, on-farm trials, participatory-research, tricot
:::
:::

\newpage

# Code metadata {#required-metadata .unnumbered}

| **Code metadata description**                 | **Please fill in this column**                             |
|:--------------------------|:--------------------------|
| Current code version                                            | 0.4                                                       |
| Code repository    | <https://github.com/AgrDataSci/gosset>                    |
| Legal code license                                              | MIT                                                       |
| Code versioning system used                                     | git                                                       |
| Software code languages, tools, and services used               | R                                                         |
| Compilation requirements, operating environments & dependencies | R                                                         |
| Link to developer documentation             | <https://agrdatasci.github.io/gosset/>                    |
| Support email for questions                                     | [kaue.desousa@inn.no](mailto:kaue.desousa@inn.no){.email} |

: *Code metadata*

# Motivation and significance

Participatory experimentation approaches have been increasingly applied in agricultural research [@deRoo2019farm]. While collecting data in ranking format is uncommon in general agricultural research settings, it is often collected in participatory experiments [@Coe2002AnalyzingRA]. Recently developed approaches for on-farm experimentation, such as the tricot methodology are based on the collection of data in ranking format [@vanetten_beza_2019]. On the other hand, newly proposed approaches for synthesis of crop variety evaluation data largely depend on the analysis of ranking data [@brown2020data].

The analysis of ranking data requires the use of appropriate statistical models such as Plackett-Luce [@luce_individual_1959; @Plackett] or Bradley-Terry [@bradley1952rank]. Functionality for fitting Bradley-Terry and Plackett-Luce models are available in R with the packages BradleyTerry2 [@BradleyTerry2] and PlackettLuce [@Turner2020] respectively. However, extended functionality was required for the entire data science workflow, which usually includes: (1) Data preparation and cleaning, (2) modelling and validation, and (3) results presentation. For (1) gosset provides functions for converting and preparing data into ranking or pairwise format required by the packages PlackettLuce and BradleyTerry2 respectively. For (2), gosset provides functions for model selection and validation using cross-validation. In the case of (3), enhanced functionality for plotting model results is provided by the gosset package.

# Software description

The R package gosset provides functionality supporting the analysis workflows in agricultural experimentation, especially with rank-based approaches. The package is available in The Comprehensive R Archive Network (CRAN) and can be installed by executing `install.packages("gosset")`. The package is named in honor to William Sealy Gosset, known by the pen name ‘Student’, a pioneer of modern statistics in small sample experimental design and analysis [@Ziliak_2019].

## Software Architecture

The R package gosset is structured following the guidelines described in the manual for creating R add-on packages [@r_extensions_2022]. This structure basically consist of files DESCRTIPTION, LICENSE, NAMESPACE and NEWS, and directories data, dev, docs, inst, man, R, and vignettes. The package functions were developed following the S3 methods style [@r_extensions_2022] and are contained in the R sub-directory.

## Software Functionalities

### Data management and preparation

* `rank_binomial` transforms a ranking object into a binary comparisons, as required by package BradleyTerry2 [@BradleyTerry2].  
* `rank_numeric` converts numeric values into rankings. The parameter `ascending = ` indicates if the rankings should be made considering the numeric values in ascending order. The default is `asceding = FALSE`. This function is useful when the data were collected as numerical observations, for instance, in a experiment measuring crop yield.  
* `rank_tricot` transforms data in tricot format into PlackettLuce rankings.

### Modelling

* `AIC` computes the Akaike Information Criterion [@akaike1974] for a Bradley-Terry model [@BradleyTerry2] or a Plackett-Luce model [@Turner2020].  
* `btpermute` deviance-based forward variable selection [@lysen2009permuted] procedure for Bradley-Terry models.
* `crossvalidation` performs k-fold cross-validation, where k could be specified by the user.The default is 10-fold. Folds can be provided as a vector for a custom cross-validation, such as blocked cross-validation.  
* `forward` executes forward variable selection with cross-validation.  
* `kendallTau` computes the Kendall-tau rank correlation coefficient between two rankings [@kendall_1938].  
* `kendallW` computes Kendall's W (coefficient of concordance) among observed rankings and those predicted by the Plackett-Luce model [@Kendall_1939].  
* `pseudoR2` computes goodness-of-fit metrics, such as McFadden's pseudo-R2 [@mcfadden1973conditional].  

### Visualization and results presentation

* `compare` is a visualization approach to compare measures from two different methods [@MartinBland1986].
* `plot` provides an alternative S3 method to `plot.pltree()` method implemented by the PlackettLuce package.  
* `regret` computes the regret coefficients, the loss under the worst possible outcome. A common heuristic
in risk assessment strategy [@Loomes_1982].  
* `reliability` computes the probability of a set of items to outperform a reference item. A common
heuristic in plant breeding [@eskridge_1992].  
* `worth_bar` creates a bar plot of the estimated *worth* for each evaluated item.  
* `worth_map` creates a heatmap plot of the estimated log-worth for all items considering each of the
evaluated traits.

# Illustrative example

To demonstrate the functionality of the gosset package, we use the `nicabean` dataset, which was generated with decentralized on-farm trials of common bean (*Phaseolus vulgaris* L.) varieties in Nicaragua over five seasons (between 2015 and 2016). Following the tricot  approach [@vanetten_beza_2019], farmers were asked to test in their farms three varieties of common bean. The varieties were randomly assigned as incomplete blocks of size three (out of 10 varieties). The farmers assessed which of the three varieties had the best and worst performance in eight traits (vigor, architecture, resistance to pests, resistance to diseases, tolerance to drought, yield, marketability, and taste). The farmers also provided their overall appreciation about the varieties, i.e., which variety had the best and the worst performance based on the overall performance considering all the traits. To analyze the data, we use the Plackett-Luce model implemented in the R package *PlackettLuce* [@Turner2020].


The `nicabean` is a list with two data frames. The first, `trial`, contains the trial data with farmers’ evaluations, ranked from 1 to 3, with 1 being the higher ranked variety and 3 the lowest ranked variety for the given trait and incomplete block. The rankings in this dataset were previously transformed from tricot rankings (where participants indicate best and worst) to ordinal rankings using the function `rank_tricot()`. The second data frame, `covar`, contains the covariates associated to the on-farm trial plots and farmers. This example will require the packages PlackettLuce [@Turner2020], climatrends [@climatrends], chirps [@chirps] and ggplot2 [@ggplot2].

``` {r starting, message = FALSE, eval = TRUE, echo = TRUE}
library("gosset")
library("PlackettLuce")
library("climatrends")
library("chirps")
library("ggplot2")

data("nicabean", package = "gosset")
load("nicabean_temp_ind.rda")

dat <- nicabean$trial

covar <- nicabean$covar

traits <- unique(dat$trait)

```

To start the analysis of the data, we transform the rankings into Plackett-Luce rankings using the function `rank_numeric()`. We run iteratively over the traits adding the rankings to a list called `R`. Since the varieties are ranked in an ascending order, with 1 being the higher ranked and 3 the lower ranked, we use the argument `asceding = TRUE` to indicate which order should be used.

```{r rankings, message = FALSE, eval = TRUE, echo = TRUE}
R <- vector(mode = "list", length = length(traits))

for (i in seq_along(traits)) {

  dat_i <- subset(dat, dat$trait == traits[i])

  R[[i]] <- rank_numeric(data = dat_i,
                         items = "item",
                         input = "rank",
                         id = "id",
                         ascending = TRUE)
}

```

Then, using the function `kendallTau()` we can assess the Kendall tau ($\tau$) coefficient [@kendall_1938]. This approach can be used, for example, to assess the drivers of farmers choices or to prioritize traits to be tested in a next stage of tricot trials (e.g. a lite version of tricot with no more than 4 traits to assess). We use the overall appreciation as the reference trait, and compare the Kendall tau with the other 8 traits.

```{r kendall1, message=FALSE, eval=TRUE, echo=TRUE}
baseline <- which(grepl("OverallAppreciation", traits))

kendall <- lapply(R[-baseline], function(X){
  kendallTau(x = X, y = R[[baseline]])
})

kendall <- do.call("rbind", kendall)

kendall$trait <- traits[-baseline]
```

The kendall correlation shows that farmers prioritized the traits yield ($\tau$ = 0.749), taste ($\tau$ = 0.653) and marketability ($\tau$ = 0.639) when assessing overall appreciation.


```{r kendall2, message=FALSE, eval=TRUE, echo=FALSE}

kendall <- kendall[,c(3, 1)]
kendall[,2] <- round(kendall[,2], 3)

kable(kendall,
          caption = "Kendall tau correlation between 'overall performance' and the other traits assessed in the Nicaragua bean on-farm trials.",
          align = "l",
          row.names = FALSE)

```


Then, for each trait, we fit a Plackett-Luce model using the function `PlackettLuce()` from the package of the same name. This will allow us to continue the analysis of the trial data using the other functions in the package gosset.

```{r PLmodel, message=FALSE, eval=TRUE, echo=TRUE}

mod <- lapply(R, PlackettLuce)

```

The `worth_map()` function can be used to visually assess item performance based on different characteristics. The values represented in a worth_map are log-worth estimates. From the breeder or product developer perspective the function `worth_map()` offers a visualization tool to help in identifying item performance based on different characteristics.

```{r worthmap, message=FALSE, eval=TRUE, echo=TRUE, fig.cap="Trait performance (log-worth) of bean varieties in Niragua. Variety 'Amadeus' is set as reference (log-worth = 0). Blue values indicate a superior performance of varieties for a given trait, compared to the reference.  Red values indicate a variety with weak performance for the given trait, compared to the reference."}
worth_map(mod[-baseline],
          labels = traits[-baseline],
          ref = "Amadeus 77") +
  labs(x = "Variety",
       y = "Trait")
```

To consider the effect of climate factors on yield, we use agro-climatic covariates to fit a Plackett-Luce tree. For simplicity, we use the total rainfall (Rtotal) derived from CHIRPS data [@Funk2015], and computed using the R packages chirps [@chirps] and [@climatrends]. However, additional covariates can be used in a Plackett-Luce tree, for example using temperature data from R package ag5Tools [@ag5tools] or nasapower [@nasapower]. 

We request the CHIRPS data using the package chirps. Data should be returned as a matrix. This process can take some minutes to be implemented.

```{r chirps, message=FALSE, eval=FALSE, echo=TRUE}
dates <- c(min(covar[, "planting_date"]),
           max(covar[, "planting_date"]) + 70)

chirps <- get_chirps(covar[, c("longitude","latitude")], 
                     dates = as.character(dates),
                     as.matrix = TRUE,
                     server = "ClimateSERV")
```

```{r chirps2, message=FALSE, eval=TRUE, echo=FALSE}

load("nicabean_chirps.rda")

```

Than we prepare the matrix to compute the rainfall indices using the function `rainfall()` from package climatrends.

```{r chirps3, message=FALSE, eval=FALSE, echo=TRUE}
dates <- c(min(covar[, "planting_date"]),
           max(covar[, "planting_date"]) + 70)

chirps <- get_chirps(covar[, c("longitude","latitude")], 
                     dates = as.character(dates),
                     as.matrix = TRUE,
                     server = "ClimateSERV")
```



To be linket to covariates, the rankings should be coerced to 'grouped rankings'. For this we used the function `group()` from PlackettLuce. We retain the ranking corresponding to yield.

```{r , message=FALSE, eval=TRUE, echo=TRUE}
R <- vector(mode = "list", length = length(traits))

for (i in seq_along(traits)) {

  dat_i <- subset(dat, dat$trait == traits[i])

  R[[i]] <- rank_numeric(data = dat_i,
                         items = "item",
                         input = "rank",
                         id = "id",
                         ascending = TRUE,
                         group = TRUE)
}
```

Now we can fit the Plackett-Luce tree with climate covariates. Notice that we used the 9^th^ element in the list
of rankings as we are only using the overall appreciation ranking.

```{r , message=FALSE, eval=TRUE, echo=TRUE}

R <- R[[9]]

pld <- cbind(R, nicabean_temp_ind)

pl <- pltree(R ~ .,
             alpha = .6,
             data = pld)
```

The following is an example of the plot made with the function ``plot`` in the gosset package.
```{r , message=FALSE, eval=FALSE, echo=TRUE}
plot(pl)

```
!["Plackett-Luce tree plot with gosset function *plot*"](pltree_01.png)


\newpage  

We can use the function ``reliability`` to compute the reliability of the evaluated common bean
varieties in each of the resulting nodes of the Plackett-Luce tree (Table 3).  


```{r rel1, message=FALSE, eval=TRUE, echo=FALSE}
# nicabean_rel <- reliability(pl, ref = "Amadeus 77")
# 
# kable(t(nicabean_rel), col.names = c("node 2", "node 3"), caption = "Reliability of evaluated varieties
#       in each of the resulting nodes of the Plackett-Luce tree")



```

With the function ``crossvalidation`` we can validate the model.


```{r, message=FALSE, eval=TRUE, echo=FALSE}
nb_cv <- crossvalidation(R ~ .,
                         alpha = .6,
                         data = pld)



```
```{r cv, message=FALSE, eval=TRUE, echo=FALSE}


kable(nb_cv$coeffs[,c(1:4, 7, 8)], caption = "Results of 10-fold random cross-validation")



```

# Impact

Reproducible and efficient workflows are fundamental in scientific research (Lowndes et al. 2017). The gosset package provides functionality that was not previously available from other R packages and which enabled scientific studies based on the analysis of ranking data. This functionality enables making the entire workflow to be reproducible and more efficient. The utility of the gosset package has been demonstrated by enabling studies based on the analysis of ranking data. For instance, @vanEtten2019, @Moyo_2021  and @deSousa2021 applied the Plackett-Luce model in combination with recursive partitioning [@Turner2020;@Zeileis2008]. In these studies, the gosset package supported data preparation, model validation and results presentation tasks.

# Conclusions

We described the functionality of the R package gosset to support the synthesis and analysis of ranking data. The package provide functions not available in existing R packages for analyzing ranking data. We provided an illustrative example covering the main functionality across the stages involved in the analysis workflow.

# Conflict of Interest

No conflict of interest exists: We wish to confirm that there are no known conflicts of interest associated with this publication and there has been no significant financial support for this work that could have influenced its outcome.

# Acknowledgements {#acknowledgements .unnumbered}

We acknowledge Olga Spellman (Science Writing Service of the Alliance of Bioversity International and CIAT) for English editing of this manuscript

\newpage  

# References

::: {#refs}
:::
